
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D√©tail de la recette</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="header-inner">
      <h1>D√©tail de la recette</h1>
    </div>
  </header>

  <main>
    <div class="detail-card">
      <button id="back-btn">‚Üê Retour</button>
      <span class="favorite-icon" id="favorite-detail">‚òÖ</span>
      <img id="recipe-image" src="" alt="Image de la recette">
      <div class="detail-content">
        <h2 id="recipe-title"></h2>
        <p><strong>Cat√©gorie :</strong> <span id="recipe-category"></span></p>
        <p><strong>Temps :</strong> <span id="recipe-time"></span></p>
        <h3>Ingr√©dients</h3>
        <ul id="recipe-ingredients"></ul>
        <h3>Description</h3>
        <p id="recipe-description"></p>
      </div>
      <div class="actions">
        <button id="edit-btn">‚úèÔ∏è Modifier</button>
        <button id="delete-btn">üóë Supprimer</button>
      </div>
    </div>
  </main>

  <div id="notification"></div>

  <!-- Modal pour modifier la recette (identique √† celui de cr√©ation) -->
  <div id="edit-recipe-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
    <div class="modal-content">
      <span class="close-btn" role="button" aria-label="Fermer la modale">&times;</span>
      <h2 id="edit-modal-title">Modifier recette</h2>
      <form id="edit-recipe-form">
        <label for="edit-title">Titre</label>
        <input type="text" id="edit-title" required>

        <label for="edit-category">Cat√©gorie</label>
        <select id="edit-category" required>
          <option value="Plat">Plats</option>
          <option value="Dessert">Desserts</option>
          <option value="Entr√©e">Entr√©es</option>
          <option value="Snack">Snacks</option>
          <option value="Cocktail">Cocktails</option>
        </select>

        <label for="edit-time">Temps</label>
        <input type="text" id="edit-time" required>

        <label for="edit-ingredients">Ingr√©dients (s√©par√©s par des virgules)</label>
        <textarea id="edit-ingredients" required></textarea>

        <label for="edit-description">Description</label>
        <textarea id="edit-description" required></textarea>

        <label for="edit-image">Image (URL, optionnelle)</label>
        <input type="url" id="edit-image">

        <!-- Options horizontales (identiques au modal cr√©ation) -->
        <div class="modal-options">
          <label><input type="checkbox" id="edit-favorite-checkbox"> Favori</label>
          <label><input type="checkbox" id="edit-modal-vege"> V√©g√©</label>
          <label><input type="checkbox" id="edit-modal-grogros"> Grogros</label>
        </div>

        <button type="submit">Modifier</button>
      </form>
    </div>
  </div>

  <script>
    const API_URL = "https://mon-site-recette-backend.onrender.com/recipes";
    const params = new URLSearchParams(window.location.search);
    const recipeId = params.get("id");

    const backBtn = document.getElementById("back-btn");
    const favoriteIcon = document.getElementById("favorite-detail");
    const notif = document.getElementById("notification");

    // Edit modal elements
    const editModal = document.getElementById("edit-recipe-modal");
    const editCloseBtn = editModal.querySelector(".close-btn");
    const editForm = document.getElementById("edit-recipe-form");

    const editTitle = document.getElementById("edit-title");
    const editCategory = document.getElementById("edit-category");
    const editTime = document.getElementById("edit-time");
    const editIngredients = document.getElementById("edit-ingredients");
    const editDescription = document.getElementById("edit-description");
    const editImage = document.getElementById("edit-image");

    const editFavoriteCheckbox = document.getElementById("edit-favorite-checkbox");
    const editVege = document.getElementById("edit-modal-vege");
    const editGrogros = document.getElementById("edit-modal-grogros");

    let recipe = null;

    function showNotification(message, type="success") {
      notif.textContent = message;
      notif.className = "";
      notif.classList.add("show", type);
      setTimeout(() => notif.classList.remove("show"), 3000);
    }

    async function loadRecipe() {
      try {
        const res = await fetch(`${API_URL}/${recipeId}`);
        if (!res.ok) throw new Error("Recette introuvable");
        recipe = await res.json();
        populateDetail();
      } catch {
        window.location.href = "index.html";
      }
    }

    function populateDetail() {
      document.getElementById("recipe-title").textContent = recipe.title;
      document.getElementById("recipe-category").textContent = recipe.category;
      document.getElementById("recipe-time").textContent = recipe.time;
      document.getElementById("recipe-description").innerHTML = recipe.description.replace(/\n/g,"<br>");
      document.getElementById("recipe-ingredients").innerHTML =
        Array.isArray(recipe.ingredients) ? recipe.ingredients.map(i => `<li>${i}</li>`).join("") : "";

      const imgEl = document.getElementById("recipe-image");
      if(recipe.image){
        imgEl.src = recipe.image;
        imgEl.style.display = "block";
        imgEl.alt = `Photo de ${recipe.title}`;
      } else imgEl.style.display="none";

      favoriteIcon.classList.toggle("active", recipe.favorite);
    }

    backBtn.addEventListener("click", ()=> window.location.href="index.html");

    // Favori toggle
    favoriteIcon.addEventListener("click", async ()=>{
      try {
        const res = await fetch(`${API_URL}/${recipe._id}/favorite`, { method:"PUT" });
        const updated = await res.json();
        recipe.favorite = updated.favorite;
        favoriteIcon.classList.toggle("active", updated.favorite);
        showNotification(updated.favorite ? "Ajout√©e aux favoris" : "Retir√©e des favoris");
      } catch {
        showNotification("Erreur lors du changement de favori","error");
      }
    });

    // Supprimer recette
    document.getElementById("delete-btn").addEventListener("click", async ()=>{
      if(!confirm("Voulez-vous vraiment supprimer cette recette ?")) return;
      try {
        await fetch(`${API_URL}/${recipe._id}`, { method:"DELETE" });
        showNotification("Recette supprim√©e","error");
        setTimeout(()=>window.location.href="index.html",1000);
      } catch {
        showNotification("Erreur lors de la suppression","error");
      }
    });

    // Modifier recette
    document.getElementById("edit-btn").addEventListener("click", ()=>{
      editTitle.value = recipe.title;
      editCategory.value = recipe.category;
      editTime.value = recipe.time;
      editIngredients.value = recipe.ingredients.join(", ");
      editDescription.value = recipe.description;
      editImage.value = recipe.image || "";
      editFavoriteCheckbox.checked = recipe.favorite;
      editVege.checked = recipe.vege || false;
      editGrogros.checked = recipe.grogros || false;
      editModal.style.display = "block";
    });

    editCloseBtn.addEventListener("click", ()=> editModal.style.display="none");
    window.addEventListener("click", e=>{ if(e.target===editModal) editModal.style.display="none"; });

    editForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const updatedRecipe = {
        title: editTitle.value,
        category: editCategory.value,
        time: editTime.value,
        ingredients: editIngredients.value.split(",").map(i=>i.trim()).filter(Boolean),
        description: editDescription.value,
        image: editImage.value || "",
        favorite: editFavoriteCheckbox.checked,
        vege: editVege.checked,
        grogros: editGrogros.checked
      };
      try {
        const res = await fetch(`${API_URL}/${recipe._id}`, {
          method:"PUT",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(updatedRecipe)
        });
        if(res.ok){
          recipe = await res.json();
          populateDetail();
          showNotification("Recette modifi√©e !");
          editModal.style.display="none";
        } else {
          const data = await res.json();
          showNotification(data.error || "Erreur lors de la modification","error");
        }
      } catch {
        showNotification("Erreur serveur","error");
      }
    });

    loadRecipe();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D√©tail de la recette</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="detail-page">
  <button id="back-btn">‚Üê Retour</button>
  <div id="recipe-detail"></div>
  <div class="actions">
    <button id="edit-btn">Modifier</button>
    <button id="delete-btn">Supprimer</button>
  </div>
</div>

<!-- MODAL MODIFICATION -->
<div id="edit-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Modifier la recette</h2>

    <form id="edit-form">
      <input type="text" id="edit-title" placeholder="Titre" required>

      <select id="edit-category" required>
        <option value="Plat">Plat</option>
        <option value="Entr√©e">Entr√©e</option>
        <option value="Dessert">Dessert</option>
        <option value="Snack">Snack</option>
        <option value="Cocktail">Cocktail</option>
      </select>

      <input type="text" id="edit-time" placeholder="Temps de pr√©paration" required>

      <textarea id="edit-ingredients" placeholder="Ingr√©dients (s√©par√©s par des virgules)" required></textarea>
      <textarea id="edit-description" placeholder="Description" required></textarea>

      <input type="text" id="edit-image" placeholder="URL de l'image">

      <div class="modal-filters">
        <label><input type="checkbox" id="edit-favorite"> Favori</label>
        <label><input type="checkbox" id="edit-vege"> V√©g√©</label>
        <label><input type="checkbox" id="edit-gluten"> Gluten</label>
        <label><input type="checkbox" id="edit-grogros"> Grogros</label>
      </div>

      <button type="submit">Enregistrer</button>
    </form>
  </div>
</div>

<!-- MODAL SUPPRESSION -->
<div id="delete-modal" class="modal">
  <div class="modal-content">
    <h2>Confirmer la suppression</h2>
    <p>Voulez-vous vraiment supprimer cette recette ?</p>
    <div class="actions">
      <button id="cancel-delete">Annuler</button>
      <button id="confirm-delete">Supprimer</button>
    </div>
  </div>
</div>

<div id="notification"></div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://mon-site-recette-backend.onrender.com/recipes";
const recipeId = new URLSearchParams(window.location.search).get("id");
if (!recipeId) window.location.href = "index.html";

/* ================= ELEMENTS ================= */
const recipeDetail = document.getElementById("recipe-detail");
const editModal = document.getElementById("edit-modal");
const deleteModal = document.getElementById("delete-modal");

const editTitle = document.getElementById("edit-title");
const editCategory = document.getElementById("edit-category");
const editTime = document.getElementById("edit-time");
const editIngredients = document.getElementById("edit-ingredients");
const editDescription = document.getElementById("edit-description");
const editImage = document.getElementById("edit-image");

const editFavorite = document.getElementById("edit-favorite");
const editVege = document.getElementById("edit-vege");
const editGluten = document.getElementById("edit-gluten");
const editGrogros = document.getElementById("edit-grogros");

let currentRecipe = null;

/* ================= NOTIFICATION ================= */
function showNotification(message, type = "success") {
  const notif = document.getElementById("notification");
  notif.textContent = message;
  notif.className = `show ${type}`;
  setTimeout(() => notif.className = "", 3000);
}

/* ================= FETCH ================= */
async function fetchRecipe() {
  try {
    const res = await fetch(`${API_URL}/${recipeId}`);
    if (!res.ok) throw new Error();
    currentRecipe = await res.json();
    renderRecipe(currentRecipe);
  } catch {
    showNotification("Impossible de charger la recette", "error");
  }
}

function renderRecipe(recipe) {
  recipeDetail.innerHTML = `
    ${recipe.image ? `<img src="${recipe.image}" alt="Image de ${recipe.title}">` : ""}
    <h2>${recipe.title}</h2>
    <p><strong>Cat√©gorie :</strong> ${recipe.category}</p>
    <p><strong>Temps :</strong> ${recipe.time}</p>

    <h3>Ingr√©dients :</h3>
    <ul>${recipe.ingredients.map(i => `<li>${i}</li>`).join("")}</ul>

    <h3>Description :</h3>
    <p>${recipe.description}</p>

    <div class="recipe-tags">
      ${recipe.favorite ? "‚òÖ Favori " : ""}
      ${recipe.vege ? "üå± V√©g√© " : ""}
      ${recipe.gluten ? "üö´ Gluten " : ""}
      ${recipe.grogros ? "üç≤ Grogros" : ""}
    </div>
  `;
}

/* ================= NAVIGATION ================= */
document.getElementById("back-btn").onclick = () => {
  window.location.href = "index.html";
};

/* ================= MODIFIER ================= */
document.getElementById("edit-btn").onclick = () => {
  if (!currentRecipe) return;

  editTitle.value = currentRecipe.title;
  editCategory.value = currentRecipe.category;
  editTime.value = currentRecipe.time;
  editIngredients.value = currentRecipe.ingredients.join(", ");
  editDescription.value = currentRecipe.description;
  editImage.value = currentRecipe.image || "";

  editFavorite.checked = currentRecipe.favorite;
  editVege.checked = currentRecipe.vege;
  editGluten.checked = currentRecipe.gluten;
  editGrogros.checked = currentRecipe.grogros;

  editModal.style.display = "block";
};

/* Fermer modales */
document.querySelectorAll(".close-btn").forEach(btn => {
  btn.onclick = () => btn.closest(".modal").style.display = "none";
});
window.onclick = e => {
  if (e.target === editModal) editModal.style.display = "none";
  if (e.target === deleteModal) deleteModal.style.display = "none";
};

/* Submit modification */
document.getElementById("edit-form").onsubmit = async e => {
  e.preventDefault();

  const updatedRecipe = {
    title: editTitle.value,
    category: editCategory.value,
    time: editTime.value,
    ingredients: editIngredients.value.split(",").map(i => i.trim()).filter(Boolean),
    description: editDescription.value,
    image: editImage.value,
    favorite: editFavorite.checked,
    vege: editVege.checked,
    gluten: editGluten.checked,
    grogros: editGrogros.checked
  };

  try {
    const res = await fetch(`${API_URL}/${recipeId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updatedRecipe)
    });
    if (!res.ok) throw new Error();
    showNotification("Recette modifi√©e !");
    editModal.style.display = "none";
    fetchRecipe();
  } catch {
    showNotification("Erreur lors de la modification", "error");
  }
};

/* ================= SUPPRIMER ================= */
document.getElementById("delete-btn").onclick = () => {
  deleteModal.style.display = "block";
};

document.getElementById("cancel-delete").onclick = () => {
  deleteModal.style.display = "none";
};

document.getElementById("confirm-delete").onclick = async () => {
  try {
    await fetch(`${API_URL}/${recipeId}`, { method: "DELETE" });
    window.location.href = "index.html";
  } catch {
    showNotification("Erreur lors de la suppression", "error");
  }
};

/* ================= INIT ================= */
fetchRecipe();
</script>

</body>
</html>

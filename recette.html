<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D√©tail de la recette</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="detail-page">
    <button id="back-btn">‚Üê Retour</button>
    <div id="recipe-detail"></div>
    <div class="actions">
      <button id="edit-btn">Modifier</button>
      <button id="delete-btn">Supprimer</button>
    </div>
  </div>

  <!-- Modal de modification -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Modifier la recette</h2>
      <form id="edit-form">
        <input type="text" id="edit-title" placeholder="Titre" required>
        <select id="edit-category" required>
          <option value="Plat">Plat</option>
          <option value="Entr√©e">Entr√©e</option>
          <option value="Dessert">Dessert</option>
          <option value="Snack">Snack</option>
          <option value="Cocktail">Cocktail</option>
        </select>
        <input type="text" id="edit-time" placeholder="Temps de pr√©paration" required>
        <textarea id="edit-ingredients" placeholder="Ingr√©dients (s√©par√©s par des virgules)" required></textarea>
        <textarea id="edit-description" placeholder="Description" required></textarea>
        <input type="text" id="edit-image" placeholder="URL de l'image">

        <div class="modal-filters">
          <label><input type="checkbox" id="edit-favorite"> Favori</label>
          <label><input type="checkbox" id="edit-vege"> V√©g√©</label>
          <label><input type="checkbox" id="edit-gluten"> Gluten Free</label>
          <label><input type="checkbox" id="edit-grogros"> Grogros</label>
        </div>

        <button type="submit">Enregistrer</button>
      </form>
    </div>
  </div>

  <!-- Modal suppression -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <h2>Confirmer la suppression</h2>
      <p>Voulez-vous vraiment supprimer cette recette ?</p>
      <div class="actions">
        <button id="cancel-delete">Annuler</button>
        <button id="confirm-delete">Supprimer</button>
      </div>
    </div>
  </div>

  <div id="notification"></div>

  <script>
    const API_URL = "https://mon-site-recette-backend.onrender.com/recipes";

    const recipeDetail = document.getElementById("recipe-detail");
    const backBtn = document.getElementById("back-btn");
    const editBtn = document.getElementById("edit-btn");
    const deleteBtn = document.getElementById("delete-btn");

    const editModal = document.getElementById("edit-modal");
    const deleteModal = document.getElementById("delete-modal");
    const closeBtns = document.querySelectorAll(".close-btn");
    const editForm = document.getElementById("edit-form");

    const cancelDelete = document.getElementById("cancel-delete");
    const confirmDelete = document.getElementById("confirm-delete");

    const notif = document.getElementById("notification");

    let recipeId = new URLSearchParams(window.location.search).get("id");
    let currentRecipe = null;

    function showNotification(message, type = "success") {
      notif.textContent = message;
      notif.className = "";
      notif.classList.add("show", type);
      setTimeout(() => notif.classList.remove("show"), 3000);
    }

    async function fetchRecipe() {
      try {
        const res = await fetch(`${API_URL}/${recipeId}`);
        if (!res.ok) throw new Error("Erreur de chargement");
        const recipe = await res.json();
        currentRecipe = recipe;
        renderRecipe(recipe);
      } catch (err) {
        showNotification("Impossible de charger la recette", "error");
      }
    }

    function renderRecipe(recipe) {
      recipeDetail.innerHTML = `
        ${recipe.image ? `<img src="${recipe.image}" alt="Image de ${recipe.title}">` : ""}
        <h2>${recipe.title}</h2>
        <p><strong>Cat√©gorie :</strong> ${recipe.category}</p>
        <p><strong>Temps :</strong> ${recipe.time}</p>
        <h3>Ingr√©dients :</h3>
        <ul>${recipe.ingredients.map(i => `<li>${i}</li>`).join("")}</ul>
        <h3>Description :</h3>
        <p>${recipe.description}</p>
        <div class="recipe-tags">
          ${recipe.favorite ? `<span class="favorite-icon active">‚òÖ Favori</span>` : ""}
          ${recipe.vege ? `<span class="tag">üå± V√©g√©</span>` : ""}
          ${recipe.glutenFree ? `<span class="tag">üö´ Gluten</span>` : ""}
          ${recipe.grogros ? `<span class="tag">üç≤ Grogros</span>` : ""}
        </div>
      `;
    }

    // --- Navigation ---
    backBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });

    // --- Modal fermeture ---
    closeBtns.forEach(btn => {
      btn.addEventListener("click", () => btn.parentElement.parentElement.style.display = "none");
    });
    window.addEventListener("click", e => {
      if (e.target === editModal) editModal.style.display = "none";
      if (e.target === deleteModal) deleteModal.style.display = "none";
    });

    // --- Modifier ---
    editBtn.addEventListener("click", () => {
      if (!currentRecipe) return;
      document.getElementById("edit-title").value = currentRecipe.title;
      document.getElementById("edit-category").value = currentRecipe.category;
      document.getElementById("edit-time").value = currentRecipe.time;
      document.getElementById("edit-ingredients").value = currentRecipe.ingredients.join(", ");
      document.getElementById("edit-description").value = currentRecipe.description;
      document.getElementById("edit-image").value = currentRecipe.image || "";
      document.getElementById("edit-favorite").checked = currentRecipe.favorite || false;
      document.getElementById("edit-vege").checked = currentRecipe.vege || false;
      document.getElementById("edit-gluten").checked = currentRecipe.glutenFree || false;
      document.getElementById("edit-grogros").checked = currentRecipe.grogros || false;

      editModal.style.display = "block";
    });

    editForm.addEventListener("submit", async e => {
      e.preventDefault();
      const updatedRecipe = {
        title: document.getElementById("edit-title").value,
        category: document.getElementById("edit-category").value,
        time: document.getElementById("edit-time").value,
        ingredients: document.getElementById("edit-ingredients").value.split(",").map(i => i.trim()).filter(Boolean),
        description: document.getElementById("edit-description").value,
        image: document.getElementById("edit-image").value,
        favorite: document.getElementById("edit-favorite").checked,
        vege: document.getElementById("edit-vege").checked,
        glutenFree: document.getElementById("edit-gluten").checked,
        grogros: document.getElementById("edit-grogros").checked
      };

      try {
        const res = await fetch(`${API_URL}/${recipeId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedRecipe)
        });
        if (res.ok) {
          showNotification("Recette mise √† jour !");
          editModal.style.display = "none";
          fetchRecipe();
        } else {
          const data = await res.json();
          showNotification(data.error || "Erreur lors de la modification", "error");
        }
      } catch {
        showNotification("Erreur serveur", "error");
      }
    });

    // --- Supprimer ---
    deleteBtn.addEventListener("click", () => {
      deleteModal.style.display = "block";
    });

    cancelDelete.addEventListener("click", () => {
      deleteModal.style.display = "none";
    });

    confirmDelete.addEventListener("click", async () => {
      try {
        const res = await fetch(`${API_URL}/${recipeId}`, { method: "DELETE" });
        if (res.ok) {
          showNotification("Recette supprim√©e !");
          window.location.href = "index.html";
        } else {
          showNotification("Erreur lors de la suppression", "error");
        }
      } catch {
        showNotification("Erreur serveur", "error");
      }
    });

    fetchRecipe();
  </script>
</body>
</html>
